title: "Linear regression of corals and inverts"
author: "Journ Galvan"
date: "4/23/2020"
output: html_document
---

```{r setup, include=TRUE}
knitr::opts_chunk$set(echo = TRUE)
```

### Code referenced from lines 83-125 in "Coral Condition Data Preliminary Analysis - Stier Lab Moorea Summer 2019" Author: Joseph Curtis
```{r load libraries}
# Load libraries
library(here)
library(tidyverse)
library(vegan)
library(reshape)
library(ggplot2)
#library(hrbrthemes)
```

```{r load data}
# Load data
branch_width <- read.csv(here("photogrammetry_data/branchwidth_data.csv"))
coral_pg <- read.csv(here("photogrammetry_data/galvan_journ_datasheet_v2.csv"))
coral_field <- read.csv(here("photogrammetry_data/field_experiment_colony_measurements_moorea_summer2019.csv"))
cafi_surveys <- read.csv(here("cafi_data/revised_cafi_data_moorea_summer2019_11_27.csv"))
cafi_field <- read.csv(here("cafi_data/prelim_cafi_counts_moorea_summer2019.csv"))
```


### Incorporate CAFI data
```{r}
# Uncount CAFI data from field experiment
cafi_field_long <- uncount(cafi_field, count) %>% select(order, coral_id, type, code, cafi_size_mm, known_unknown) %>%
  separate(coral_id, c("reef", NA), remove = FALSE)
cafi_surveys <- cafi_surveys %>% select(sort, coral_id, type, code, cafi_size_mm, known_unknown) %>%
  separate(coral_id, c("reef", NA), remove = FALSE)
```

```{r}
# Analyze known organisms until further data cleaning
cafi_combined <- bind_rows(cafi_surveys, cafi_field_long) %>% 
  filter(known_unknown == "known")
```

```{r}
# Calculate CAFI richness, abundance, and diversity (shannon weiner) for each coral
cafi_summarized <- group_by(cafi_combined, coral_id) %>%
  summarise(num_cafi = n(), cafi_richness = length(unique(code)), cafi_present = paste(sort(unique(code)), collapse = ";"))
cafi_summarized$sw <- cafi_combined %>% 
  count(code, coral_id = coral_id) %>% 
  spread(code,n) %>% 
  mutate_all(list(~replace_na(.,0))) %>% 
  select(-coral_id) %>% 
  diversity(index = "shannon")
```


### Incorporate coral data 
```{r}
# Clean field data
coral_field2 <- coral_field %>%
  dplyr::rename(branch = branch_width)
# Clean photogrammetry morphometric data
coral_pg$volume_pg <- as.numeric(as.character(coral_pg$volume_pg)) # Convert factor to numeric
# Clean photogrammetry branch width data and take averages of branch distance for each coral
branch_width$branch_distance_mm <- as.numeric(as.character(branch_width$branch_distance_mm)) # Convert factor to numeric
branch_w_summarized <- group_by(branch_width, coral_id) %>% 
  summarise(avg_w_mm = sum(branch_distance_mm)/n(), 
            measurements = length(unique(replicate_measurement)), 
            locations = paste(sort(unique(location)), collapse = ";"))
```

```{r}
# Add branch, cafi, and size_class columns from field data to morphometric photogrammetry data 
coral_dim <- merge(coral_pg, branch_w_summarized, by = "coral_id") %>%
  merge(coral_field2, by = "coral_id") %>%
  select(coral_id, row, column, branch, cafi, size_class, volume_pg, surface_area, interstitial_volume, avg_w_mm) 
# could also use lapply(cafi_coral)
```


### Combine cleaned CAFI data with photogrammetry coral data
```{r}
# Combine cafi_summarized with coral_dim
cafi_coral <- merge(cafi_summarized, coral_dim, by ="coral_id")
```

### Correlating morphological measurements
```{r}
# Relating coral volume to average branch distance
#vol_branch <- ggplot(cafi_coral, aes(x=volume_pg, y=avg_w_mm))+
  #geom_point()+
  #geom_smooth(method = lm, color="red", se=FALSE)+
  #theme_classic()+
  #facet_wrap(~branch)+
  #labs(y="Average branch distance (mm)", x="Volume (m^3)", title = "Relating coral volume to average branch distance")

#vol_branch

vol_branch <- ggplot(cafi_coral, aes(x=volume_pg, y= avg_w_mm, shape= branch, color= as.factor(branch)))+ #changed 'group' to 'shape'
  geom_point()+
  geom_smooth(method = lm, se=FALSE)+
  theme_classic()+
  theme(legend.position = "none")+
  labs(y= "Average branch distance mm", x= expression(paste("Volume m"^{3})))

# fit linear model to coral volume and average branch distance
fit_vol_branch_tight <- lm(avg_w_mm~volume_pg, data=cafi_coral, subset=(branch=="tight"))
fit_vol_branch_wide <- lm(avg_w_mm~volume_pg, data=cafi_coral, subset=(branch=="wide"))

#summary(fit_vol_branch_tight) #p-value: 0.1476 no sig. slope for volume and branch distance in tight branched coral
#summary(fit_vol_branch_wide) #p-value: 0.003289 sig. slope for volume and branch distance in wide branched coral

# Relating coral volume to surface area
#vol_SA <- ggplot(cafi_coral, aes(x=volume_pg, y=surface_area))+
  #geom_point()+
  #geom_smooth(method = lm, color="red", se=FALSE)+
  #theme_classic()+
  #facet_wrap(~branch)+
  #labs(y="SA m^2", x="Volume m^3", title = "Relating coral volume to surface area")

#vol_SA

vol_SA <- ggplot(cafi_coral, aes(x=volume_pg, y= surface_area, shape= branch, color= as.factor(branch)))+ #changed 'group' to 'shape'
  geom_point()+
  geom_smooth(method = lm, se=FALSE, show.legend = FALSE)+
  theme_classic()+
  theme(legend.position = "right")+
  labs(y= expression(paste("Surface Area m"^{2})), x= expression(paste("Volume m"^{3})))

compare_branch_SA <- vol_branch + vol_SA
compare_branch_SA

# fit linear model to coral volume and surface area
fit_vol_SA_tight <- lm(surface_area~volume_pg, data=cafi_coral, subset=(branch=="tight"))
fit_vol_SA_wide <- lm(surface_area~volume_pg, data=cafi_coral, subset=(branch=="wide"))

summary(fit_vol_SA_tight) #p-value: 1.727e-08 sig. slope for volume and surface area in tight branched corals
summary(fit_vol_SA_wide) #p-value: 3.549e-08 sig. slope for volume and surface area in tight branched corals

#plot(fit_vol_SA_tight)
#plot(fit_vol_SA_wide)

fit_combined <- lm(surface_area~branch/volume_pg - 1, data = cafi_coral)

summary(fit_combined)
#plot(fit_combined)

# eliminate 'removed 2 row' errors
# update figures automatically
# individual linear regressions
# check for normallity?
# formatted table w summary statistics
```

### Visualize invertebrate data

```{r} 
# Create two graphs showing invert abundance and coral volume for both tight and wide corals
invert_volume <- ggplot(cafi_coral, aes(x=volume_pg, y=num_cafi))+
  geom_point()+
  geom_smooth(method = lm, color="red", se=FALSE)+
  theme_classic()+
  facet_wrap(~branch)+
  labs(y="Invertebrate abundance", x="Coral volume m^3", title = "Invertebrate abundance and coral volume")

invert_volume
```

```{r}
# Scatter plot of average branch width and invertebrate abundance for both wide and tight corals
invert_branch <- ggplot(cafi_coral, aes(x=avg_w_mm, y=num_cafi))+
  geom_point()+
  geom_smooth(method = lm, color = "red", se=FALSE)+
  theme_classic()+
  facet_wrap(~branch)+
  labs(y="Invertebrate abundance", x="Avg. branch distance mm", title = "Invertebrate abundance and avgerage branch distance of coral")

invert_branch
```

```{r}
# Boxplot of invert abundance
invert_box <- ggplot(cafi_coral, aes(x= branch, y=num_cafi, color = branch))+
  geom_boxplot(width = 0.5)+
  geom_jitter()+ # adds data on top of box plot
  scale_color_manual(values = c("firebrick1", "steelblue2"))+
  scale_y_continuous(limits= c(0, max(cafi_coral$num_cafi + 3)), breaks = c(0, 10, 20, 30, 40, 50))+
  theme_classic()+
  labs(y="Invertebrate abundance", x="Coral branching", title = "Invertebrate abundance and coral branching")

invert_box

# Boxplot of invertebrate species richness per coral for both tight and wide branching
richness_box <- ggplot(cafi_coral, aes(x= branch, y=cafi_richness, color = branch))+
  geom_boxplot(width = 0.5)+
  geom_jitter()+
  scale_color_manual(values = c("firebrick1", "steelblue2"))+
  scale_y_continuous(limits= c(0, max(cafi_coral$cafi_richness + 5)), breaks = c(0, 5, 10, 15, 20))+
  theme_classic()+
  labs(y="Invertebrate species richness", x="Coral branching", title = "Invertebrate species richness and coral branching")

richness_box
  
# Invertebrate species richness barplot for all tight and all wide corals
branch_richness <- group_by(cafi_coral, branch) %>%
  summarise(cafi_richness = length(unique(cafi_present)), cafi_present = paste(sort(unique(cafi_present)), collapse = ";")) %>%
  select(branch, cafi_richness, cafi_present)
  
#ggplot(branch_richness, aes(x=branch, y=cafi_richness))+
  #geom_bar()+
  #scale_fill_grey(start = 0.25, end = 0.75)+
  #theme(legend.position="none")
```


### Dataframe of Trapezid crab abundance and combine with photogrammetry coral data
```{r}
# Calculate Trapezid abundance and richness for each coral
its_a_trap <- cafi_combined %>% filter(str_detect(code, "^TR"))
trap_summarized <- group_by(its_a_trap, coral_id) %>%
  summarise(num_cafi = n(), cafi_richness = length(unique(code)), cafi_present = paste(sort(unique(code)), collapse = ";"))
```

```{r}
# Combine with photogrammetry data
trap_w_coral_dim <- merge(trap_summarized, coral_dim, by = "coral_id")
trap_w_coral_dim$num_trap <- trap_w_coral_dim$num_cafi %>% replace_na(0) %>% rename("num_trap")
trap_w_coral_dim$trap_richness <- trap_w_coral_dim$cafi_richness %>% replace_na(0) %>% rename("trap_richness")
trap_w_coral_dim <- trap_w_coral_dim %>% select(-cafi_richness, -num_cafi)
```


### Visualize Trapezid data
```{r}
# Scatter plot of volume and Trapezid abundance for both wide and tight corals
trap_volume <- ggplot(trap_w_coral_dim, aes(x=volume_pg, y=num_trap))+
  geom_point()+
  geom_smooth(method = lm, color = "red", se=FALSE)+
  theme_classic()+
  facet_wrap(~branch)+
  labs(y="Trapezid crab abundance", x="Coral volume m^3", title = "Trapezid crab abundance and coral volume")

trap_volume
```

```{r}
# Scatter plot of average branch width and Trapezid abundance for both wide and tight corals
trap_branch <- ggplot(trap_w_coral_dim, aes(x=avg_w_mm, y=num_trap))+
  geom_point()+
  geom_smooth(method = lm, color = "red", se=FALSE)+
  theme_classic()+
  facet_wrap(~branch)+
  labs(y="Trapezid crab abundance", x="Avg. branch distance mm", title = "Trapezid crab abundance and average branch distance of coral")

trap_branch
```

```{r}
# Boxplot of Trapezid crab abundance
trap_box <- ggplot(trap_w_coral_dim, aes(x= branch, y=num_trap, color = branch))+
  geom_boxplot(width = 0.5)+
  geom_jitter(height = 0)+ # adds data on top of box plot
  scale_color_manual(values = c("firebrick1", "steelblue2"))+
  scale_y_continuous(limits= c(0, max(trap_w_coral_dim$num_trap + 5)), breaks = c(0, 5, 10, 15, 20))+
  theme_classic()+
  labs(y="Trapezid abundance", x="Coral branching", title = "Trapezid crab abundance for tight and wide branching coral")

trap_box

# Boxplot of Trapezid species richness per coral for both tight and wide branching
trap_richness_box <- ggplot(trap_w_coral_dim, aes(x= branch, y=trap_richness, color = branch))+
  geom_boxplot(width = 0.5)+
  geom_jitter(height = 0)+ # adds data on top of box plot
  scale_color_manual(values = c("firebrick1", "steelblue2"))+
  scale_y_continuous(limits= c(0, max(trap_w_coral_dim$trap_richness + 1)), breaks = c(0, 1, 2, 3, 4, 5))+
  theme_classic()+
  labs(y="Trapezid species richness", x="Coral branching", title = "Trapezid crab species richness for tight and wide branching coral")

trap_richness_box
```

### Dataframe of Alpheus shrimp abundance and combine with photogrammetry coral data
```{r}
alph <- cafi_combined %>% filter(str_detect(code, "^AL"))
alph_summarized <- group_by(alph, coral_id) %>%
  summarise(num_cafi = n(), cafi_richness = length(unique(code)), cafi_present = paste(sort(unique(code)), collapse = ";"))
```

```{r}
alph_w_coral_dim <- merge(alph_summarized, coral_dim, by = "coral_id")
alph_w_coral_dim$num_alph <- alph_w_coral_dim$num_cafi %>% replace_na(0) %>% rename("num_alph")
alph_w_coral_dim$alph_richness <- alph_w_coral_dim$cafi_richness %>% replace_na(0) %>% rename("alph_richness")
alph_w_coral_dim <- alph_w_coral_dim %>% select(-cafi_richness, -num_cafi)
```


### Visualize Alpheus shrimp data
```{r}
# Scatter plot of volume and Alpheus shrimp abundance for both wide and tight corals
alph_volume <- ggplot(alph_w_coral_dim, aes(x=volume_pg, y=num_alph))+
  geom_point()+
  geom_smooth(method = lm, color = "red", se=FALSE)+
  theme_classic()+
  facet_wrap(~branch)+
  labs(y="Alpheus abundance", x="Coral volume m^3", title = "Alpheus shrimp abundance and coral volume")

alph_volume
```

```{r}
# Scatter plot of average branch width and Trapezid abundance for both wide and tight corals
alph_branch <- ggplot(alph_w_coral_dim, aes(x=avg_w_mm, y=num_alph))+
  geom_point()+
  geom_smooth(method = lm, color = "red", se=FALSE)+
  theme_classic()+
  facet_wrap(~branch)+
  labs(y="Alpheus abundance", x="Avg. branch distance mm", title = "Alpheus shrimp abundance and average branch width of coral")

alph_branch
```

```{r}
# Boxplot of Alpheus shrimp abundance
alph_box <- ggplot(alph_w_coral_dim, aes(x= branch, y=num_alph, color = branch))+
  geom_boxplot(width = 0.5)+
  geom_jitter(height = 0.25)+ # adds data on top of box plot
  scale_color_manual(values = c("firebrick1", "steelblue2"))+
  scale_y_continuous(limits= c(0, max(alph_w_coral_dim$num_alph + 1)), breaks = c(0, 1, 2, 3, 4))+
  theme_classic()+
  labs(y="Alpheus abundance", x="Coral branching", title = "Alpheus shrimp abundance for tight and wide branching coral")

alph_box

# Boxplot of Alpheus shrimp species richness per coral for both tight and wide branching
alph_richness_box <- ggplot(alph_w_coral_dim, aes(x= branch, y=alph_richness, color = branch))+
  geom_boxplot(width = 0.5)+
  geom_jitter(height = 0.25)+ # adds data on top of box plot
  scale_color_manual(values = c("firebrick1", "steelblue2"))+
  scale_y_continuous(limits= c(0, max(alph_w_coral_dim$alph_richness + 1)), breaks = c(0, 1, 2, 3))+
  theme_classic()+
  labs(y="Alpheus species richness", x="Coral branching", title = "Alpheus shrimp species richness for tight and wide branching coral")

alph_richness_box
```