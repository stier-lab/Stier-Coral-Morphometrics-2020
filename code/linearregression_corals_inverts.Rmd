---
title: "Linear regression of corals and inverts"
author: "Journ Galvan"
date: "4/23/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Code referenced from lines 83-125 in "Coral Condition Data Preliminary Analysis - Stier Lab Moorea Summer 2019" Author: Joseph Curtis
```{r load libraries}
# Load libraries
library(here)
library(tidyverse)
library(vegan)
library(reshape)
```


```{r load data}
# Load data
branch_width <- read.csv(here("photogrammetry_data/branchwidth_data.csv"))
coral_pg <- read.csv(here("photogrammetry_data/galvan_journ_datasheet_v2.csv"))
coral_field <- read.csv(here("photogrammetry_data/field_experiment_colony_measurements_moorea_summer2019.csv"))
cafi_surveys <- read.csv(here("cafi_data/revised_cafi_data_moorea_summer2019_11_27.csv"))
cafi_field <- read.csv(here("cafi_data/prelim_cafi_counts_moorea_summer2019.csv"))
```


```{r convert}
# Convert factor to numeric
coral_pg$volume_pg <- as.numeric(as.character(coral_pg$volume_pg))
#lapply(coral_pg)
```


### Incorporate CAFI data
```{r uncount}
# Uncount CAFI data from field experiment
cafi_field_long <- uncount(cafi_field, count) %>% select(order, coral_id, type, code, cafi_size_mm, known_unknown) %>%
  separate(coral_id, c("reef", NA), remove = FALSE)

cafi_surveys <- cafi_surveys %>% select(sort, coral_id, type, code, cafi_size_mm, known_unknown) %>%
  separate(coral_id, c("reef", NA), remove = FALSE)
```


```{r known}
# Analyze known organisms until further data cleaning
cafi_combined <- bind_rows(cafi_surveys, cafi_field_long) %>% 
  filter(known_unknown == "known")
```


```{r richness, abundance, diversity of coral}
# Calculate CAFI richness, abundance, and diversity (shannon weiner) for each coral
cafi_summarized <- group_by(cafi_combined, coral_id) %>%
  summarise(num_cafi = n(), cafi_richness = length(unique(code)), cafi_present = paste(sort(unique(code)), collapse = ";"))

cafi_summarized$sw <- cafi_combined %>% 
  count(code, coral_id = coral_id) %>% 
  spread(code,n) %>% 
  mutate_all(list(~replace_na(.,0))) %>% 
  select(-coral_id) %>% 
  diversity(index = "shannon")
```


### Incorporate coral photogrammetry data 
```{r}
# Convert factor to numeric
branch_width$branch_distance_mm <- as.numeric(as.character(branch_width$branch_distance_mm))

# Create dataframe branch_w_summarized with the following varaibles
branch_w_summarized <- group_by(branch_width, coral_id) %>%
  summarise(avg_w_mm = sum(branch_distance_mm)/n(), measurements = length(unique(replicate_measurement)), locations = paste(sort(unique(location)), collapse = ";"))

```

```{r coral_pg}
# Combine coral_pg with branch_w_summarized 
coral_pg_branch <- merge(coral_pg, branch_w_summarized, by = "coral_id")

# Create dataframe with only morphometric measurements applied to invertebrates
coral_dim <- coral_pg_branch %>% select(coral_id, row, column, volume_pg, surface_area, interstitial_volume, avg_w_mm) 
#lapply(cafi_coral)
```


### Combine cleaned CAFI data with coral photogrammetry data
```{r combine cafi with coral}
# Combine cafi_summarized with coral_dim
cafi_coral <- merge(cafi_summarized, coral_dim, by ="coral_id")
```


```{r scatter plot}
# Scatter plot of volume and invert abundance
plot(num_cafi~volume_pg, data = cafi_coral,
    xlab = "Coral volume m^(3)", ylab = "CAFI abundance", main = "Coral volume and invert abundance")

# Overlay best fit line on existing plot
fit <- lm(num_cafi~volume_pg, data = cafi_coral)
abline(fit,col = "green")
```


### Dataframe of trapezid abundance
```{r Trapezid}
# Calculate Trapezid abundance and richness for each coral
its_a_trap <- cafi_combined %>% filter(str_detect(code, "^TR"))
trap_summarized <- group_by(its_a_trap, coral_id) %>%
  summarise(num_cafi = n(), cafi_richness = length(unique(code)), cafi_present = paste(sort(unique(code)), collapse = ";"))
```

### Combine trapezid with coral
```{r combine}
# Combine with photogrammetry data
trap_w_coral_dim <- merge(trap_summarized, coral_dim, by = "coral_id")

trap_w_coral_dim$num_trap <- trap_w_coral_dim$num_cafi %>% replace_na(0) %>% rename("num_trap")
trap_w_coral_dim$trap_richness <- trap_w_coral_dim$cafi_richness %>% replace_na(0) %>% rename("trap_richness")
trap_w_coral_dim <- trap_w_coral_dim %>% select(-cafi_richness, -num_cafi)
```


```{r trapezid scatter plot}
# Scatter plot of volume and trapezid abundance
plot(num_trap~volume_pg, data = trap_w_coral_dim,
     xlab = "Coral volume m^3",
     ylab = "Trapezid crab abundance", main = "Coral volume and trapezid crab abundance")

# Overlay best fit line on existing plot
fit <- lm(num_trap~volume_pg, data = trap_w_coral_dim)
abline(fit,col = "green")
```


