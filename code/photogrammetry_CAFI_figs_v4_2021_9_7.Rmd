---
output:
  html_document: default
  pdf_document: default
---
# Title: "Figures for Photogrammetry-CAFI manuscript"
author: "Joseph Curtis (modifying code by Journ Galvan)"
date: "9/8/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries, message=FALSE, include=FALSE}

rm(list=ls())

# Load libraries
library(here)
library(tidyverse)
library(vegan)
library(cowplot)
library(ggpubr)
library(conflicted)
library(ggpmisc)
library(kableExtra)
library(knitr)
library(qpcR)
library(investr)

conflict_prefer("rename","dplyr")
conflict_prefer("filter", "dplyr")
conflict_prefer("select","dplyr")
conflict_prefer("plot_grid","cowplot")
conflict_prefer("get_legend", "cowplot")

```

```{r load_data, include=FALSE}
# Load data 
branch_width <- read.csv(here("morphometric_data","branchwidth_data.csv")) 
coral_pg <- read.csv(here("morphometric_data","photogrammetry_data_v3_2020_9_10.csv")) 
coral_field <- read.csv(here("morphometric_data","field_experiment_colony_measurements_moorea_summer2019.csv"))
updated_cafi <- read.csv(here("cafi_data","cafi_data_w_taxonomy_summer2019_2020_5_21.csv"))
```

```{r data_cleaning, include=FALSE}

# Data Preparation and Cleaning

# CAFI data
updated_cafi2 <- updated_cafi %>% filter(str_detect(coral_id, "^FE")) %>%
  select(master_sort, coral_id, code, type, search_term, lowest_level, phylum, genus, species, general_notes) 

# Calculate CAFI richness, abundance, and diversity (shannon weiner) for each coral (inverts)

cafi_summarized2 <- group_by(updated_cafi2, coral_id) %>%
  summarise(num_cafi = n(), cafi_richness = length(unique(code)), cafi_present = paste(sort(unique(code)), collapse = ";"))
cafi_summarized2$sw <- updated_cafi2 %>% 
  count(code, coral_id = coral_id) %>% 
  spread(code,n) %>% 
  mutate_all(list(~tidyr::replace_na(.,0))) %>% 
  select(-coral_id) %>% 
  diversity(index = "shannon")

# Clean field data
coral_field2 <- coral_field %>%
  rename(branch = branch_width) 
  

# Clean photogrammetry morphometric data
coral_pg$volume_pg <- as.numeric(as.character(coral_pg$volume_pg)) # Convert factor to numeric
coral_pg <- coral_pg %>% filter(use == "y") %>%   mutate(volume_pg=volume_pg*10^6, #convert m^3 to cm^3
         max_hull_volume=max_hull_volume*10^6, #convert m^3 to cm^3
         max_hull_surface_area=max_hull_surface_area*10^4,#convert m^2 to cm^2
         surface_area=surface_area*10^4, #convert m^2 to cm^2
         height_pg=height_pg*100, #convert m to cm
         length_pg=length_pg*100, #convert m to cm
         width_pg=width_pg*100) #convert m to cm

# Clean photogrammetry branch width data and take averages of branch distance for each coral
branch_width$branch_distance_mm <- as.numeric(as.character(branch_width$branch_distance_mm)) # Convert factor to numeric
branch_w_summarized <- group_by(branch_width, coral_id) %>%
  summarise(avg_w_cm = mean(branch_distance_mm)/10, #take average branch distance and convert mm to cm
            measurements = n(), 
            locations = paste(sort(unique(location)), collapse = ";"))

#Create primary data frame for analysis

coral_dim <- merge(coral_pg, branch_w_summarized, by = "coral_id") %>%
 merge(coral_field2, by = "coral_id") %>%
  rename(max_hull_SA = max_hull_surface_area,
                SA = surface_area)

# Swap length to be the bigger linear dimension, width to be the smaller one

coral_dim <- coral_dim %>% mutate(length_pg_temp = if_else(length_pg > width_pg, length_pg, width_pg),
                                  width_pg_temp = if_else(length_pg < width_pg, length_pg, width_pg),
                                  length_field_temp = if_else(length_field > width_field, length_field, width_field),
                                  width_field_temp = if_else(length_field < width_field, length_field, width_field)) %>% 
                            select(-length_pg, -width_pg, -length_field, -width_field) %>%
                            rename(length_pg = length_pg_temp, width_pg = width_pg_temp,
                                   length_field = length_field_temp, width_field = width_field_temp)
          

coral_dim$interstitial_space <- coral_dim$max_hull_volume - coral_dim$volume_pg #calculate available space by subtracting software estimated volume from convex hull volume

coral_dim$SAV <- coral_dim$SA / coral_dim$volume_pg #calculate surface area to volume relationship

coral_dim$convexity <- coral_dim$volume_pg / coral_dim$max_hull_volume #calculate proportion occupied, high ratios indicate less free space between branches

coral_dim$packing <- coral_dim$SA / coral_dim$max_hull_SA #how much of an objects surface area is situated internally

coral_dim$sphericity <- ((pi^(1/3))*((6*coral_dim$volume_pg)^(2/3)))/coral_dim$SA #calculate sphericity or how close the object is to a sphere

coral_dim$diff_est <- coral_dim$volume_field-coral_dim$volume_pg #actual overestimation

coral_dim$prop_est <- (coral_dim$volume_field - coral_dim$volume_pg)/coral_dim$volume_pg #proportion overestimated 

coral_dim <- coral_dim %>% select(-"use", -position, -total_photos, -photos_not_aligned, -measurements, -locations) %>% 
 rename(notes_pg = notes.x, notes_field = notes.y)

# Undid filtering of removal corals only.. may need to reintroduce step at some later point

coral_dim$branch_conv <- ifelse(coral_dim$convexity>=0.5, "tight","wide") #classifies wide and tight branching coral based on convexity
  
# Merge coral and CAFI data
cafi_coral <- left_join(coral_dim, cafi_summarized2, by ="coral_id") %>% filter(cafi == "empty")

#Cleanup

remove(branch_w_summarized, cafi_summarized2, branch_width, coral_field, coral_field2, updated_cafi, coral_pg, updated_cafi2)
```
# Overview

The purpose of this document is to outline some preliminary results and interpretation of data collected in Moorea, French Polynesia, regarding the relative utility of measuring coral colonies via photogrammetry versus traditional manual measurements.

# Glossary/formulas

$Volume_{photo}$: Volume calculated through photogrammetry of live coral surface (base, epoxy, and background cropped) $(cm^3)$

$Volume_{hull}$: Volume of convex hull, or the greatest possible volume of coral object $(cm^3)$

$SA_{photo}$: Surface Area from photogrammetry models, only includes live coral surface, not underside of base $(cm^2)$

$SA_{hull}$: Surface Area from convex hull, lowest possible surface area of coral $(cm^2)$

**Interstitial space**: $Volume_{hull}$  - $Volume_{photo}$; higher value means more empty space in convex hull volume $(cm^3)$

**SA/V**: $SA_{photo}$/$Volume_{photo}$ (both from photogrammetry); proxy for rugosity, higher values mean more complex coral structure

**Convexity**: $Volume_{photo}$ / $Volume_{hull}$; proportion of convex hull occupied by object, lower values indicate more empty space inside convex hull. In a coral, this could be due to wide branch distance or higher complexity structure (convoluted, deep interstitial spaces) 


**Packing**: $SA_{photo}$ / $SA_{hull}$; another measurement of rugosity and complexity, higher values suggest more structural complexity

**Sphericity**: ${\pi^{1/3}}*(6*Volume_{photo}^{2/3})/(SA_{photo})$; the degree to which the shape of a coral resembles a sphere - higher value means more spherical. 

**Branch Width**: Average distance between the vertices of two branches on a coral. In this case, measurements were made at 5 locations per colony using photogrammetry and averaged. Manual measurements of branch distance for these corals would have been possible, but weren't made.


```{r supp_fig1_creator, message=FALSE, include = FALSE}
#SUPPLEMENTAL FIGURE 1


#Volume - Convex Hull vs ellipsoid
convex <- ggplot(coral_dim, aes(x=max_hull_volume, y = volume_field))+ 
  geom_abline(intercept = 0, slope = 1, size = 1, lty = "dashed", color='dodgerblue4') + 
  geom_point(color = "black", size = 4, alpha = 0.7, fill = "coral", pch = 21) +
  geom_smooth(method=lm, color = "black", se = FALSE) +
  scale_y_continuous(breaks=seq(0,max(coral_dim$volume_field), by = 5000))+
  scale_x_continuous(breaks=seq(0,max(coral_dim$max_hull_volume, na.rm = TRUE)+1500, by = 5000))+
  theme_classic()+
  labs(y= expression(paste("Ellipsoid Volume (cm"^{3},")")), 
       x= expression(paste("Convex Hull Volume (cm"^{3},")"))) +
  
  theme(text = element_text(size = 13)) #x intercept changed to be forced through 0

height <- ggplot(coral_dim, aes(x=height_pg, y=height_field))+ 
  geom_abline(intercept = 0, slope = 1, size = 1, lty = "dashed", color='dodgerblue4') + 
  geom_point(color = "black", size = 4, alpha = 0.7, fill = "coral", pch = 21) +
  geom_smooth(method=lm, color = "black", se = FALSE)+
  theme_classic()+
  xlim(c(0,max(coral_dim$height_pg + 2))) +
  ylim(c(0,max(coral_dim$height_field + 2))) +
  labs(y= "Manual Height (cm)", x= "Photogrammetry Height (cm)")+
   #x intercept changed to be forced through 0
  theme(text = element_text(size = 13))

#Length
length <- ggplot(coral_dim, aes(x=length_pg, y=length_field))+ 
  geom_abline(intercept = 0, slope = 1, size = 1, lty = "dashed", color='dodgerblue4') +
  geom_point(color = "black", size = 4, alpha = 0.7, fill = "coral", pch = 21) +
  geom_smooth(method=lm, color = "black", se = FALSE)+
  xlim(c(0,max(coral_dim$length_pg + 2))) +
  ylim(c(0,max(coral_dim$length_field + 2))) +
  theme_classic()+
  labs(y= "Manual Length (cm)", x= "Photogrammetry Length (cm)")+
   #x intercept changed to be forced through 0
  theme(text = element_text(size = 13))

#Width
width <- ggplot(coral_dim, aes(x=width_pg, y=width_field))+ 
 geom_point(color = "black", size = 4, alpha = 0.7, fill = "coral", pch = 21) +
  geom_smooth(method=lm, color = "black", se = FALSE) +
  theme_classic()+
  xlim(c(0,max(coral_dim$width_pg + 2))) +
  ylim(c(0,max(coral_dim$width_field + 2))) +
  labs(y= "Manual Width (cm)", x= "Photogrammetry Width (cm)") +
  geom_abline(intercept = 0, slope = 1, size = 1, lty = "dashed", color='dodgerblue4') + #x intercept changed to be forced through 0
  theme(text = element_text(size = 13))

 #x intercept changed to be forced through 0
fig1 <- cowplot::plot_grid(convex, length, width, height, ncol = 2, nrow = 2, 
          align = "vh", labels = "AUTO")

# ggsave(here("code","figures","precision_comparison.pdf"), fig1, device = "pdf", useDingbats = FALSE, width = 10, height = 7)

```
  
```{r fig1, fig.width = 9, fig.height = 6, message=FALSE, echo = FALSE}
fig1
```


```{r fig2 prep, include=FALSE, include=FALSE}



lm_abun_man <- lm(num_cafi~volume_field, data = cafi_coral)
nls_abun_man <- nls(num_cafi ~ a*volume_field^beta, cafi_coral, start = list(a = 1.35, beta = 0.32))

# Abun v Skeleton

lm_abun_skel <- lm(num_cafi~volume_pg, data = cafi_coral)
nls_abun_skel <- nls(num_cafi ~ a*volume_pg^beta, cafi_coral, start = list(a = 1, beta = 1))

# Rich v Ellipsoid

lm_rich_man <- lm(cafi_richness~volume_field, data = cafi_coral)
nls_rich_man <- nls(cafi_richness ~ a*volume_field^beta, cafi_coral, start = list(a = 1, beta = 1))

# Rich v Skeleton

lm_rich_skel <- lm(cafi_richness~volume_pg, data = cafi_coral)
nls_rich_skel <- nls(cafi_richness ~ a*volume_pg^beta, cafi_coral, start = list(a = 1, beta = 1))

# Rich v Hull

lm_rich_hull <- lm(cafi_richness~max_hull_volume, data = cafi_coral)
nls_rich_hull <- nls(cafi_richness ~ a*max_hull_volume^beta, cafi_coral, start = list(a = 1, beta = 1))


# Abun v Hull

lm_abun_hull <- lm(num_cafi~max_hull_volume, data = cafi_coral)
nls_abun_hull <- nls(num_cafi ~ a*max_hull_volume^beta, cafi_coral, start = list(a = 1, beta = 1))

formula1 <- y~a*x^beta

plot_man_abun <- as.data.frame(predFit(nls_abun_man, interval = "confidence", level = 0.95)) %>% cbind(cafi_coral)
plot_skel_abun <- as.data.frame(predFit(nls_abun_skel, interval = "confidence", level = 0.95)) %>% cbind(cafi_coral)
plot_hull_abun <- as.data.frame(predFit(nls_abun_hull, interval = "confidence", level = 0.95)) %>% cbind(cafi_coral)
plot_man_rich <- as.data.frame(predFit(nls_rich_man, interval = "confidence", level = 0.95)) %>% cbind(cafi_coral)
plot_skel_rich <- as.data.frame(predFit(nls_rich_skel, interval = "confidence", level = 0.95)) %>% cbind(cafi_coral)
plot_hull_rich <- as.data.frame(predFit(nls_rich_hull, interval = "confidence", level = 0.95)) %>% cbind(cafi_coral)


# cafi_coral <- cafi_coral %>% filter(coral_id != "FE-POC01") # Can be used to take out "outlier" from CAFI plots
#Plot invert abundance to  volume
invert_field <- ggplot(plot_man_abun, aes(x=volume_field, y=num_cafi)) + 
  geom_smooth(method = "nls", formula = formula1, method.args = list(start = list(a = 1, beta = 1)), se = FALSE, color = "#edae52", fill = "#edae52") +
  geom_point(color = "black", pch = 21, fill = "#edae52", size = 3.5, alpha = 0.7) +
  geom_ribbon(aes(ymin = lwr, ymax = upr), fill= "#edae52", alpha = 0.2) +
  theme_classic()+
  ylim(c(0,76)) +
  labs(y="CAFI Abundance", x= expression(paste("Ellipsoid Volume (cm"^{3},")"))) +
  theme(axis.text = element_text(size = 12.5), axis.title = element_text(size = 15),
        axis.title.x = element_blank()) +
  coord_cartesian()


#Plot invert abundance to software estimated volume
invert_pg <- ggplot(plot_skel_abun, aes(x=volume_pg, y=num_cafi))+ 
  geom_smooth(method=nls, formula = formula1, se = FALSE, method.args = list(start = list(a = 1, beta = 1)), color = "#5fb2b2", fill = "#5fb2b2")+
  geom_point(color = "black", pch = 21, fill = "#5fb2b2", size = 3.5, alpha = 0.7)+
  theme_classic()+
  geom_ribbon(aes(ymin = lwr, ymax = upr), fill= "#5fb2b2", alpha = 0.2) +
  ylim(c(0,76)) +
  labs(y="CAFI Abundance", x= expression(paste("Skeletal Volume (cm"^{3},")"))) +
  theme(axis.text = element_text(size = 12.5), axis.title = element_blank()) +
  coord_cartesian()


#Plot invert abundance to hull volume
invert_hull <- ggplot(plot_hull_abun, aes(x=max_hull_volume, y=num_cafi))+ 
  geom_smooth(method=nls, formula = formula1, method.args = list(start = list(a = 1, beta = 1)), se = FALSE, color = "dodgerblue1", fill = "dodgerblue1")+
  geom_point(color = "black", pch = 21, fill = "dodgerblue1", size = 3.5, alpha = 0.7)+
  geom_ribbon(aes(ymin = lwr, ymax = upr), fill= "dodgerblue1", alpha = 0.2) +
  theme_classic()+
  ylim(c(0,76)) +
  labs(y="CAFI Abundance", x= expression(paste("Convex Hull Volume (cm"^{3},")"))) +
  theme(axis.text = element_text(size = 12.5), axis.title = element_blank())


#Plot invert richness to manual volume
richness_field <- ggplot(plot_man_rich, aes(x=volume_field, y=cafi_richness))+ 
  geom_smooth(method=nls, formula = formula1, method.args = list(start = list(a = 1, beta = 1)), se = FALSE, color = "#edae52", fill = "#edae52")+
  geom_point(color = "black", pch = 21, fill = "#edae52", size = 3.5, alpha = 0.7)+
  geom_ribbon(aes(ymin = lwr, ymax = upr), fill= "#edae52", alpha = 0.2) +
  theme_classic()+
  labs(y="CAFI Richness", x= expression(paste("Ellipsoid Volume (cm"^{3},")"))) +
  scale_y_continuous(limits = c(0,27), breaks = seq(0,25,5)) +
  theme(axis.text = element_text(size = 12.5), axis.title = element_text(size = 15))

#Plot invert richness to software estimated volume
richness_pg <- ggplot(plot_skel_rich, aes(x=volume_pg, y=cafi_richness))+ 
  geom_smooth(method=nls, formula = formula1, method.args = list(start = list(a = 1, beta = 1)), se = FALSE, color = "#5fb2b2", fill = "#5fb2b2")+
  geom_point(color = "black", pch = 21, fill = "#5fb2b2", size = 3.5, alpha = 0.7)+
  geom_ribbon(aes(ymin = lwr, ymax = upr), fill= "#5fb2b2", alpha = 0.2) +
  theme_classic()+
  scale_y_continuous(limits = c(0,27), breaks = seq(0,25,5)) +
  labs(y="CAFI Richness", x= expression(paste("Skeletal Volume (cm"^{3},")"))) +
  theme(axis.text = element_text(size = 12.5), axis.title = element_text(size = 15),
        axis.title.y = element_blank()) 

#Plot invert richness to software estimated volume
richness_hull <- ggplot(plot_hull_rich, aes(x=max_hull_volume, y=cafi_richness))+ 
  geom_smooth(method=nls, formula = formula1, method.args = list(start = list(a = 1, beta = 1)), se = FALSE, color = "dodgerblue1", fill = "dodgerblue1")+
  geom_point(color = "black", pch = 21, fill = "dodgerblue1", size = 3.5, alpha = 0.7)+
  geom_ribbon(aes(ymin = lwr, ymax = upr), fill= "dodgerblue1", alpha = 0.2) +
  theme_classic()+
  scale_y_continuous(limits = c(0,27), breaks = seq(0,25,5)) +
  labs(y="CAFI Richness", x= expression(paste("Convex Hull Volume (cm"^{3},")"))) +
  theme(axis.text = element_text(size = 12.5), axis.title = element_text(size = 15),
        axis.title.y = element_blank())


fig2_raw <- plot_grid(invert_field, invert_hull, invert_pg, richness_field, richness_hull, richness_pg, nrow = 2, ncol = 3, align = "vh", labels = "AUTO")

ggsave(here("code","figures","man_vs_photo_cafi_v2.pdf"), fig2_raw, device = "pdf", useDingbats = FALSE, width = 9, height = 5)
```

```{r fig3, fig.width = 9, fig.height = 6, message=FALSE, echo = FALSE}
fig2_raw
```

```{r growth_fig_prep, include = FALSE}

december_manual <- read.csv(here("morphometric_data", "field_experiment_colony_measurements_moorea_december2019_v2.csv"))
december_photo <- read.csv(here("morphometric_data","maatea_experiment_photo_measurements_december_JC_2020_7_8.csv"))

december_manual$coral_id <- as.character(december_manual$coral_id)
december_photo$coral_id <- as.character(december_photo$coral_id)

december_photo <- december_photo %>% filter(coral_id %in% coral_dim$coral_id, volume_pg != "NA")

december_photo$vol_pg_aug <- coral_dim$volume_pg[match(december_photo$coral_id,coral_dim$coral_id)]
december_photo$sa_aug <-  coral_dim$SA[match(december_photo$coral_id,coral_dim$coral_id)]
december_photo$vol_hull_aug <- coral_dim$max_hull_volume[match(december_photo$coral_id,coral_dim$coral_id)]

december_photo <- december_photo %>% mutate(volume_pg = volume_pg*10^6, max_hull_volume = max_hull_volume*10^6)
december_photo <- december_photo %>% mutate(vol_growth_pg = volume_pg - vol_pg_aug,
                                            prop_growth_pg = vol_growth_pg/vol_pg_aug*100,
                                            hull_growth = max_hull_volume - vol_hull_aug,
                                            prop_hull_growth = hull_growth/vol_hull_aug*100)


december_manual <- december_manual %>% filter(coral_id %in% december_photo$coral_id) %>%
  mutate(vol_growth_man = volume_est_dec - volume_est) %>% mutate(prop_growth_man = vol_growth_man/volume_est*100)

aug_and_dec <- left_join(december_photo, december_manual, by = "coral_id")

manual_dec_trim <- december_manual %>% select(coral_id, volume = volume_est_dec, volume_aug = volume_est, growth = vol_growth_man, prop_growth = prop_growth_man) %>% mutate(method = "Ellipsoid")

photo_dec_trim <- december_photo %>% select(coral_id, volume = volume_pg, volume_aug = vol_pg_aug, growth = vol_growth_pg, prop_growth = prop_growth_pg) %>% mutate(method = "Skeleton")

photo_hull_trim <- december_photo %>% select(coral_id, volume = max_hull_volume, volume_aug = vol_hull_aug, growth = hull_growth, prop_growth = prop_hull_growth) %>% mutate(method = "Convex Hull")

december_stacked <- rbind(manual_dec_trim,photo_dec_trim, photo_hull_trim)
december_summary_stats <- december_stacked %>% group_by(method) %>% summarize(
  mean_growth = mean(growth, na.rm = TRUE), mean_prop_growth = mean(prop_growth, na.rm = TRUE),
  se_vol = sd(growth, na.rm = TRUE)/sqrt(n()), se_prop = sd(prop_growth, na.rm = TRUE)/sqrt(n()))

december_summary_stats$method <- factor(december_summary_stats$method, levels = c("Ellipsoid", "Convex Hull", "Skeleton"))
december_stacked$method <- factor(december_stacked$method, levels = c("Ellipsoid", "Convex Hull", "Skeleton"))
```


``` {r growth_figs, include = FALSE, echo = FALSE}

# Growth Mean Plots

prop_mean_plot <- ggplot(december_summary_stats, aes(x = method, y = mean_prop_growth)) +
    geom_jitter(data = december_stacked, aes(x = method, y = prop_growth, fill = method),
                width = 0.05, size = 2, alpha = 0.5, pch = 21, color = "grey50") +
    geom_errorbar(aes(ymin = mean_prop_growth - se_prop,
                      ymax = mean_prop_growth + se_prop), width = 0.3,
                  size = 0.8, color = "black") +
    geom_point(size = 3.5, pch = 21, color = "black", aes(fill = december_summary_stats$method)) +
    scale_fill_manual(labels = c("Ellipsoid", "Hull", "Skeleton"), values = c("#edae52", "dodgerblue1", "#5fb2b2")) +
    geom_hline(aes(yintercept = 0), linetype = "dashed") +
    labs(x = "", y = expression(paste("% Growth"))) +
    scale_x_discrete(expand = c(0,1)) +
    theme_classic() +
    theme(legend.position = "none", text = element_text(size = 15))

joined_growth_v_vol <- ggplot(december_stacked, aes(volume_aug, growth, color = method)) +
  geom_point(size = 3.5, alpha = 0.6, pch = 21, color = "black", aes(fill = december_stacked$method)) +
  geom_smooth(method = "lm", formula = "formula1", aes(fill = december_stacked$method), alpha = 0.2) +
  stat_poly_eq(aes(label = paste(..rr.label.., sep = "~~~")), 
               label.x.npc = "right", label.y.npc = "bottom",
               formula = formula1, parse = TRUE, size = 5) +
  theme_classic() +
  scale_fill_manual(labels = NULL, values = c("#edae52", "dodgerblue1", "#5fb2b2"), guide = FALSE) +
  scale_color_manual(labels = c("Ellipsoid","Hull", "Skeleton"), values = c("#edae52", "dodgerblue1", "#5fb2b2")) +
  labs(x = expression(paste("Initial Volume (cm"^{3},")")),
       y = expression(paste("Growth (cm"^{3},")"))) +
  facet_wrap(~method, scales = "free")

prop_growth_v_vol <- ggplot(december_stacked, aes(volume_aug, prop_growth, color = method)) +
  geom_point(size = 3.5, alpha = 0.6, pch = 21, color = "black", aes(fill = method)) +
  geom_smooth(method = "lm", formula = "formula1", aes(fill = method), alpha = 0.2) +
  stat_poly_eq(aes(label = paste(..rr.label.., sep = "~~~")), 
               label.x.npc = "right", label.y.npc = "bottom",
               formula = formula1, parse = TRUE, size = 5) +
  theme_classic() +
  scale_fill_manual(labels = NULL, values = c("#edae52", "dodgerblue1", "#5fb2b2"), guide = FALSE) +
  scale_color_manual(labels = c("Ellipsoid","Hull", "Skeleton"), values = c("#edae52", "dodgerblue1", "#5fb2b2"), guide = FALSE) +
  labs(x = expression(paste("Initial Volume (cm"^{3},")")),
       y = expression(paste("Percent Growth",")")))  +
  theme(aspect.ratio = 1/3, text = element_text(size = 13)) +
  facet_wrap(~method, scales  = "free_x", ncol = 1)

# ggsave(here("code","figures","prop_growth_boxplot.pdf"), prop_mean_plot, device = "pdf", useDingbats = FALSE, height = 4, width = 5)
# ggsave(here("code","figures","growth_vs_volume.pdf"), joined_growth_v_vol, device = "pdf", useDingbats = FALSE, height = 4, width = 6)
# ggsave(here("code","figures","joined_growth_vs_volume_prop.pdf"), prop_growth_v_vol, device = "pdf", useDingbats = FALSE, height = 4, width = 6)

prop_growth_v_vol_ellipsoid <- ggplot(aug_and_dec, aes(volume_est, prop_growth_man)) +
  geom_smooth(method = "lm", formula = "formula1", color = "#edae52", fill = "#edae52", size = 1.5) +
  geom_point(size = 3.5, alpha = 0.8, pch = 21, color = "black", fill = "#edae52") +
  stat_poly_eq(aes(label = paste(..rr.label.., sep = "~~~")), 
               label.x.npc = "right", label.y.npc = "bottom",
               formula = formula1, parse = TRUE, size = 5, color = "#edae52") +
  theme_classic() +
  ylim(c(-60,60)) +
  labs(x = expression(paste("Ellipsoid Volume (cm"^{3},")")),
       y = expression(paste("Percent Growth")))  +
  theme(text = element_text(size = 12))

prop_growth_v_vol_hull <- ggplot(aug_and_dec, aes(vol_hull_aug, prop_hull_growth)) +
  geom_smooth(method = "lm", formula = "formula1", color = "dodgerblue1", fill = "dodgerblue1", size = 1.5) +
  geom_point(size = 3.5, alpha = 0.8, pch = 21, color = "black", fill = "dodgerblue1") +
  stat_poly_eq(aes(label = paste(..rr.label.., sep = "~~~")), 
               label.x.npc = "right", label.y.npc = "bottom",
               formula = formula1, parse = TRUE, size = 5, color = "dodgerblue1") +
  theme_classic() +
  ylim(c(-60,60)) +
  labs(x = expression(paste("Hull Volume (cm"^{3},")")),
       y = expression(paste("Percent Growth")))  +
  theme(text = element_text(size = 12), axis.title.y = element_blank())

prop_growth_v_vol_pg <- ggplot(aug_and_dec, aes(vol_pg_aug, prop_growth_pg)) +
  geom_smooth(method = "lm", formula = "formula1", color = "#5fb2b2", fill = "#5fb2b2",size = 1.5) +
  geom_point(size = 3.5, alpha = 0.8, pch = 21, color = "black", fill = "#5fb2b2") +
  stat_poly_eq(aes(label = paste(..rr.label.., sep = "~~~")), 
               label.x.npc = "right", label.y.npc = "bottom",
               formula = formula1, parse = TRUE, size = 5, color = "#5fb2b2") +
  theme_classic() +
  ylim(c(-60,60)) +
  labs(x = expression(paste("Skeletal Volume (cm"^{3},")")),
       y = expression(paste("Percent Growth")))  +
  theme(text = element_text(size = 12), axis.title.y = element_blank())

sep_prop_growth_vol <- plot_grid(prop_growth_v_vol_ellipsoid, prop_growth_v_vol_hull, prop_growth_v_vol_pg,
                                    align = 'vh', nrow = 1, ncol = 3, labels = "AUTO")


# ggsave(here("code","figures","sep_growth_vs_volume_prop.pdf"), sep_prop_growth_vol, device = "pdf", useDingbats = FALSE, height = 3, width = 9)

```

```{r growth_figs_followup, include = TRUE, echo = FALSE, warning = FALSE}

joined_growth_v_vol
prop_growth_v_vol
sep_prop_growth_vol
```

```{r growth_fig_joined, fig.width = 6, fig.height = 8, include = TRUE, echo = FALSE}

joined_growth_v_vol

```

```{r tab_1_prep, message=FALSE, include=FALSE}



options(scipen = 999)
reg_sum <- function(input2, nls_x) {
  temp <- data.frame(matrix(ncol = 11))
  temp_cols <- c("Variable", "a", "SE_a", "t_a", "p_a", "b", "SE_b", "t_b", "p_b", "AIC","RMSE")
  colnames(temp) <- temp_cols
  temp$Variable <- paste(input2)
  temp$a <- signif(as.numeric(coefficients(nls_x)[1]),3)
  temp$"SE_a" <- signif(summary(nls_x)$coefficients[1,2],3)
  temp$"t_a" <- signif(summary(nls_x)$coefficients[1,3],3)
  temp$"p_a" <- signif(summary(nls_x)$coefficients[1,4],3)
  temp$b <- signif(as.numeric(coefficients(nls_x)[2]),3)
  temp$"SE_b" <- signif(summary(nls_x)$coefficients[2,2],3)
  temp$"t_b" <- signif(summary(nls_x)$coefficients[2,3],3)
  temp$"p_b" <- signif(summary(nls_x)$coefficients[2,4],3)
  temp$AIC <- signif(AIC(nls_x),5)
  temp$RMSE <- signif(qpcR::RMSE(nls_x),5)
  temp
}

abun_tab <- rbind(reg_sum("Ellipse", nls_abun_man), reg_sum("Convex Hull", nls_abun_hull),
                  reg_sum("Skeletal Volume", nls_abun_skel))
                  

```

```{r tab_1prep_rich, message=FALSE, include=FALSE}

richness_tab <- rbind(reg_sum("Ellipse", nls_rich_man), reg_sum("Convex Hull", nls_rich_hull),
                  reg_sum("Skeletal Volume", nls_rich_skel))

```


```{r pub_table_prep, include = FALSE}

tbl_raw <- rbind(abun_tab,richness_tab)

tbl_raw <- tbl_raw %>% 
  mutate_if(is.numeric, as.character) %>% 
  mutate(p_a = if_else(as.numeric(tbl_raw$p_a)>0.001, as.character(tbl_raw$p_a), "<0.001"),
         p_b = if_else(as.numeric(tbl_raw$p_b)>0.001, as.character(tbl_raw$p_b), "<0.001"))


tbl_1 <- kbl(tbl_raw, booktabs = TRUE, digits = c(1,1,1,1,1,1,3)) %>% 
  kable_classic() %>% 
  kable_styling(bootstrap_options = c("striped", "bordered")) %>% 
  pack_rows("Abundance", 1,3) %>% 
  pack_rows("Richness", 4,6) %>% 
  column_spec(6, bold = ifelse(tbl_raw$p_a < 0.05, "TRUE", "FALSE")) %>% 
  column_spec(9, bold = ifelse(tbl_raw$p_b < 0.05, "TRUE", "FALSE"))
```

```{r pub_table, include = TRUE}
tbl_1
```