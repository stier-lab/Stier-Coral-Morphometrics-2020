---
output:
  html_document: default
  pdf_document: default
---
## Title: "Outline for Photogrammetry-CAFI manuscript"
author: "Joseph Curtis (modifying code by Journ Galvan)"
date: "9/8/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries, message=FALSE, include=FALSE}

rm(list=ls())

# Load libraries
library(here)
library(tidyverse)
library(vegan)
library(reshape)
library(ggpubr)
library(zoo)
library(sjPlot)
library(sjmisc)
library(sjlabelled)
library(psych)
library(knitr)
library(faraway)
library(car)
library(MASS)
library(gridExtra)
library(grid)
library(AER)
library(conflicted)
library(cowplot)

conflict_prefer("rename","dplyr")
conflict_prefer("filter", "dplyr")
conflict_prefer("select","dplyr")
conflict_prefer("plot_grid","cowplot")
conflict_prefer("get_legend", "cowplot")

```

```{r load_data, include=FALSE}
# Load data 
branch_width <- read.csv(here("morphometric_data","branchwidth_data.csv")) 
coral_pg <- read.csv(here("morphometric_data","photogrammetry_data_v3_2020_9_10.csv")) 
coral_field <- read.csv(here("morphometric_data","field_experiment_colony_measurements_moorea_summer2019.csv"))
updated_cafi <- read.csv(here("cafi_data","cafi_data_w_taxonomy_summer2019_2020_5_21.csv"))
```

```{r data_cleaning, include=FALSE}

# Data Preparation and Cleaning

# CAFI data - Inverts only
updated_cafi2 <- updated_cafi %>% filter(str_detect(coral_id, "^FE")) %>%
  select(master_sort, coral_id, code, type, search_term, lowest_level, phylum, genus, species, general_notes) %>%
  subset(phylum!="Chordata") #filter out vertebrates

# Calculate CAFI richness, abundance, and diversity (shannon weiner) for each coral (inverts)

cafi_summarized2 <- group_by(updated_cafi2, coral_id) %>%
  summarise(num_cafi = n(), cafi_richness = length(unique(code)), cafi_present = paste(sort(unique(code)), collapse = ";"))
cafi_summarized2$sw <- updated_cafi2 %>% 
  count(code, coral_id = coral_id) %>% 
  spread(code,n) %>% 
  mutate_all(list(~tidyr::replace_na(.,0))) %>% 
  select(-coral_id) %>% 
  diversity(index = "shannon")

# Clean field data
coral_field2 <- coral_field %>%
  rename(branch = branch_width) 
  

# Clean photogrammetry morphometric data
coral_pg$volume_pg <- as.numeric(as.character(coral_pg$volume_pg)) # Convert factor to numeric
coral_pg <- coral_pg %>% filter(use == "y") %>%   mutate(volume_pg=volume_pg*10^6, #convert m^3 to cm^3
         max_hull_volume=max_hull_volume*10^6, #convert m^3 to cm^3
         max_hull_surface_area=max_hull_surface_area*10^4,#convert m^2 to cm^2
         surface_area=surface_area*10^4, #convert m^2 to cm^2
         height_pg=height_pg*100, #convert m to cm
         length_pg=length_pg*100, #convert m to cm
         width_pg=width_pg*100) #convert m to cm

# Clean photogrammetry branch width data and take averages of branch distance for each coral
branch_width$branch_distance_mm <- as.numeric(as.character(branch_width$branch_distance_mm)) # Convert factor to numeric
branch_w_summarized <- group_by(branch_width, coral_id) %>%
  summarise(avg_w_cm = mean(branch_distance_mm)/10, #take average branch distance and convert mm to cm
            measurements = n(), 
            locations = paste(sort(unique(location)), collapse = ";"))

#Create primary data frame for analysis

coral_dim <- merge(coral_pg, branch_w_summarized, by = "coral_id") %>%
 merge(coral_field2, by = "coral_id") %>%
  rename(max_hull_SA = max_hull_surface_area,
                SA = surface_area)

# Swap length to be the bigger linear dimension, width to be the smaller one

coral_dim <- coral_dim %>% mutate(length_pg_temp = if_else(length_pg > width_pg, length_pg, width_pg),
                                  width_pg_temp = if_else(length_pg < width_pg, length_pg, width_pg),
                                  length_field_temp = if_else(length_field > width_field, length_field, width_field),
                                  width_field_temp = if_else(length_field < width_field, length_field, width_field)) %>% 
                            select(-length_pg, -width_pg, -length_field, -width_field) %>%
                            rename(length_pg = length_pg_temp, width_pg = width_pg_temp,
                                   length_field = length_field_temp, width_field = width_field_temp)
          

coral_dim$interstitial_space <- coral_dim$max_hull_volume - coral_dim$volume_pg #calculate available space by subtracting software estimated volume from convex hull volume

coral_dim$SAV <- coral_dim$SA / coral_dim$volume_pg #calculate surface area to volume relationship

coral_dim$convexity <- coral_dim$volume_pg / coral_dim$max_hull_volume #calculate proportion occupied, high ratios indicate less free space between branches

coral_dim$packing <- coral_dim$SA / coral_dim$max_hull_SA #how much of an objects surface area is situated internally

coral_dim$sphericity <- ((pi^(1/3))*((6*coral_dim$volume_pg)^(2/3)))/coral_dim$SA #calculate sphericity or how close the object is to a sphere

coral_dim$diff_est <- coral_dim$volume_field-coral_dim$volume_pg #actual overestimation

coral_dim$prop_est <- (coral_dim$volume_field - coral_dim$volume_pg)/coral_dim$volume_pg #proportion overestimated 

coral_dim <- coral_dim %>% select(-"use", -position, -total_photos, -photos_not_aligned, -measurements, -locations) %>% 
 rename(notes_pg = notes.x, notes_field = notes.y)

# Undid filtering of removal corals only.. may need to reintroduce step at some later point

coral_dim$branch_conv <- ifelse(coral_dim$convexity>=0.5, "tight","wide") #classifies wide and tight branching coral based on convexity
  
# Merge coral and CAFI data
cafi_coral <- left_join(coral_dim, cafi_summarized2, by ="coral_id") %>% filter(cafi == "empty")

#Create trimmed dataset (not sure why this df is necessary.. maybe clear later on?)
dim_bind <- coral_dim %>% select(coral_id, ends_with("pg"), ends_with("field"))

#Cleanup

remove(branch_w_summarized, cafi_summarized2, branch_width, coral_field, coral_field2, updated_cafi, coral_pg, updated_cafi2)
```
## Overview

The purpose of this document is to outline some preliminary results and interpretation of data collected in Moorea, French Polynesia, regarding the relative utility of measuring coral colonies via photogrammetry versus traditional manual measurements.

# Glossary/formulas

$Volume_{photo}$: Volume calculated through photogrammetry of live coral surface (base, epoxy, and background cropped) $(cm^3)$

$Volume_{hull}$: Volume of convex hull, or the greatest possible volume of coral object $(cm^3)$

$SA_{photo}$: Surface Area from photogrammetry models, only includes live coral surface, not underside of base $(cm^2)$

$SA_{hull}$: Surface Area from convex hull, lowest possible surface area of coral $(cm^2)$

**Interstitial space**: $Volume_{hull}$  - $Volume_{photo}$; higher value means more empty space in convex hull volume $(cm^3)$

**SA/V**: $SA_{photo}$/$Volume_{photo}$ (both from photogrammetry); proxy for rugosity, higher values mean more complex coral structure

**Convexity**: $Volume_{photo}$ / $Volume_{hull}$; proportion of convex hull occupied by object, lower values indicate more empty space inside convex hull. In a coral, this could be due to wide branch distance or higher complexity structure (convoluted, deep interstitial spaces) 

*note: We should discuss whether convexity is really the best measurement to try and divide "wide" and "tight" colonies. For instance, a colony with long, skinny branches and deep interstitial spaces could hypothetically have the same convexity as one with fatter, shorter branches with more space inbetween. I think convexity will catch the extreme cases (lowest values for very widely branched colonies, highest values for very tightly branched colonies), but the middle values could be tricky, and show "intermediate branch width for different reasons*

**Packing**: $SA_{photo}$ / $SA_{hull}$; another measurement of rugosity and complexity, higher values suggest more structural complexity

**Sphericity**: ${\pi^{1/3}}*(6*Volume_{photo}^{2/3})/(SA_{photo})$; the degree to which the shape of a coral resembles a sphere - higher value means more spherical. 

*note: A coral could vary on a lot of different axes that decrease sphericity. A more complex, taller, or wider coral could all have similar sphericity values but for completely different reasons. Sphericity calculations based on convex hull rather than coral measurements may be more valuable*

**Branch Width**: Average distance between the vertices of two branches on a coral. In this case, measurements were made at 5 locations per colony using photogrammetry and averaged. Manual measurements of branch distance for these corals would have been possible, but weren't made.



```{r paired_t-test, include=FALSE}

# Paired t-test for linear measurements and volume
# par(mfrow=c(3,3))
# qqPlot(dim_bind$height_pg, dist="norm")
# qqPlot(dim_bind$height_field, dist="norm")
# qqPlot(dim_bind$length_pg, dist="norm")
# qqPlot(dim_bind$length_field, dist="norm")
# qqPlot(dim_bind$width_pg, dist="norm")
# qqPlot(dim_bind$width_field, dist="norm")
# par(mfrow=c(2,2))
# 
# par(mfrow=c(2,2))
# qqPlot(dim_bind$volume_pg, dist="norm")
# qqPlot(dim_bind$volume_field, dist="norm")
# par(mfrow=c(1,1))
# 
# #Volume data is not normal, try sqrt transformation - Do we need an actual test of this? Not sure just examining the QQ plots is enough..
dim_bind$sqrt_volume_pg <- sqrt(dim_bind$volume_pg)
dim_bind$sqrt_volume_field <- sqrt(dim_bind$volume_field)
# 
# par(mfrow=c(2,2))
# qqPlot(dim_bind$sqrt_volume_pg, dist="norm")
# qqPlot(dim_bind$sqrt_volume_field, dist="norm")
# par(mfrow=c(1,1))
#sqrt transformed volume for both measurements is normal, move to paired t-test

#Perform paired t-tests

t_vol <- t.test(dim_bind$sqrt_volume_pg,dim_bind$sqrt_volume_field, paired=TRUE) #p << .01 
t_height <- t.test(dim_bind$height_pg,dim_bind$height_field, paired=TRUE) #p << .01 
t_length <- t.test(dim_bind$length_pg,dim_bind$length_field, paired=TRUE) #p = .73
t_width <- t.test(dim_bind$width_pg,dim_bind$width_field, paired=TRUE) #p < .01

# Turn these into summary tables - measurement, mean difference and CI, t-value and CI, p-value
```

```{r paired_t-test_cleanup, include=FALSE}
remove(t_vol, t_height, t_length, t_width)
```


## Introduction Outline

* Measurements of features in marine landscapes, especially the size and distribution of habitat, can be extremely important to predicting ecological phenomena

* Traditionally, these have been measured using cheap, readily accessible tools such as observer-based surveys and manual methods

* Newer techniques such as the digital reconstruction of landscape features using photogrammetry have the potential to allow much more detailed analyses of the physical characteristics of various habitats. However, these are expensive and time-intensive

* The objective of this manuscript is to compare measurements of a foundation habitat in a marine landscape, specifically of the morphological characteristics of coral colonies, made using manual and photogrammetric tools. These data illustrate the types of information that are especially valuable that photogrammetry can provide, as well as in what contexts the investment of resources into photogrammetry tools and training might be most beneficial.

## Methods Details

* 60 coral colonies were manually measured and photographed in August and December 2019

* 30 of these colonies were sampled to describe their resident biological community of associated invertebrates and fishes (CAFI)

* Manual measurements of corals included: length, width, height, circumference. Volume of a colony can be approximated as an ellipsoid using these measurements. Branch width distance could have been measured, but was not.

* Photogrammetric measurements included: Length, width, height, volume (coral), volume (convex hull), surface area (coral), surface area (convex hull), SA:V ratio, convexity, sphericity, packing, interstitial space, average branch width distance (see definitions in glossary).

### Preliminary Results

# Visual comparison of photogrammetric and manual measurements

Here we look at how well manual measurements correlated to those made using photogrammetry. We'll examine convex hull volume and coral volume vs. ellipsoid volume extrapolated from manual measurements, as well as height, length, and width (photogrammetry vs manual)

```{r fig1_creator, message=FALSE, include = FALSE}
#Volume - Coral
volume <- ggplot(dim_bind, aes(x=volume_pg, y=volume_field))+ 
  geom_point()+
  geom_smooth(method=lm)+
  scale_y_continuous(breaks=seq(0,max(dim_bind$volume_field), by = 5000))+
  scale_x_continuous(breaks=seq(0,max(dim_bind$volume_pg)+1500, by = 2000))+
  theme_classic()+
  labs(y= expression(paste("Ellipsoid Volume (cm"^{3},")")), x= expression(paste("Coral Volume (cm"^{3},")")))+
  geom_abline(intercept = 0, slope = 1, size = 1, color='black', lty = "dashed") +
  theme(axis.text.x = element_text(angle = 305, vjust=0, hjust = .3))#x intercept changed to be forced through 0

#Volume - Convex Hull vs ellipsoid
convex <- ggplot(coral_dim, aes(x=max_hull_volume, y = volume_field))+ 
  geom_point()+
  geom_smooth(method=lm)+
  scale_y_continuous(breaks=seq(0,max(coral_dim$volume_field), by = 5000))+
  scale_x_continuous(breaks=seq(0,max(coral_dim$max_hull_volume, na.rm = TRUE)+1500, by = 5000))+
  theme_classic()+
  labs(y= expression(paste("Ellipsoid Volume (cm"^{3},")")), 
       x= expression(paste("Convex Hull Volume (cm"^{3},")"))) +
  geom_abline(intercept = 0, slope = 1, size = 1, lty = "dashed", color='black') +
    theme(axis.text.x = element_text(angle = 305, vjust=0, hjust = .3))#x intercept changed to be forced through 0

#Height
height <- ggplot(dim_bind, aes(x=height_pg, y=height_field))+ 
  geom_point()+
  geom_smooth(method=lm)+
  theme_classic()+
  labs(y= "Manual Height (cm)", x= "Photogrammetry Height (cm)")+
  geom_abline(intercept = 0, slope = 1, size = 1, lty = "dashed", color='black') #x intercept changed to be forced through 0

#Length
length <- ggplot(dim_bind, aes(x=length_pg, y=length_field))+ 
  geom_point()+
  geom_smooth(method=lm)+
  theme_classic()+
  labs(y= "Manual Length (cm)", x= "Photogrammetry Length (cm)")+
  geom_abline(intercept = 0, slope = 1, size = 1, lty = "dashed", color='black') #x intercept changed to be forced through 0

#Width
width <- ggplot(dim_bind, aes(x=width_pg, y=width_field))+ 
  geom_point()+
  geom_smooth(method=lm)+
  theme_classic()+
  labs(y= "Manual With (cm)", x= "Software Width (cm)")+
  geom_abline(intercept = 0, slope = 1, size = 1, lty = "dashed", color='black') #x intercept changed to be forced through 0
fig1 <- cowplot::plot_grid(volume, convex, NULL, length, width, height, ncol = 3, nrow = 2, 
          align = "vh", labels = c("A","B","","C","D","E"))
fig1_fin <- annotate_figure(fig1,
                top = text_grob("Photogrammetry vs. Manual Measurements", color = "black", face = "bold", size = 14),
                fig.lab = "Figure 1", fig.lab.face = "bold")  
```
  
```{r fig1, fig.width = 9, fig.height = 6, message=FALSE, echo = FALSE}
fig1_fin
```

```{r fig1_cleanup, include = FALSE}

remove(length, width, height, volume, convex, fig1)

```

It appears that the estimates of ellipsoid volume overestimate actual coral volume, but correspond well to convex hull volume as well as other manual measurements. There also appears to be a slight offset between manual and digital measurements of height, with manual measurements consistently a small amount larger than digital measurements.


From the above visualization, it appears that larger corals may experience a higher degree of overestimation from calculations of ellipsoid volume vs. coral volume. Let's look at the absolute and proportional differences between coral, convex hull, and ellipsoid volumes across the span of coral sizes to see whether the sizes of certain corals may be more closely approximated via manual measurements

```{r fig2_prep, message=FALSE, include=FALSE}
# Calculate difference between photogrammetry and manually derived measurements

coral_dim <- coral_dim %>% mutate(prop_est=(volume_field-volume_pg)/volume_pg*100, #Percent difference of ellipsoid compared to photogrammetry volume
            diff_est=volume_field-volume_pg, #absolute difference between ellipsoid and photogrammetry volume
            prop_conv = (volume_field-max_hull_volume)/max_hull_volume*100,
            diff_conv = volume_field-max_hull_volume)

#Absolute difference - coral volume
plot_est <- ggplot(coral_dim, aes(x=volume_pg, y=diff_est, color=branch))+ 
  geom_point()+
  geom_smooth(method=lm)+
  theme_classic()+
  labs(y= expression(atop("Volume (Manual - Photo)", paste("(cm"^{3},")"))), x= expression(paste("Photogrammetry Volume (cm"^{3},")"))) +
  ggtitle("Coral Volume") +
  scale_color_discrete(name = "Branch Width", labels = c("Tight","Wide")) +
  theme(legend.position="none")

#Proportional difference - coral volume
plot_prop <- ggplot(coral_dim, aes(x=volume_pg, y=prop_est, shape=branch, color=branch))+
  geom_point()+
  geom_smooth(method=lm)+
  theme_classic()+
  labs(y= expression(atop("Percent Volume Difference", "(Manual - Photo)")), x= expression(paste("Photogrammetry Volume (cm"^{3},")"))) +
  theme(legend.position = "none")

#Absolute difference - convex hull

conv_est <- ggplot(coral_dim, aes(x=max_hull_volume, y=diff_conv, color=branch_conv))+ 
  geom_point()+
  geom_smooth(method=lm)+
  theme_classic()+
  labs(y= expression(atop("Volume (Manual - Hull)", paste("(cm"^{3},")"))), x= expression(paste("Convex Hull Volume (cm"^{3},")"))) +
  ggtitle("Convex Hull") +
  xlim(c(0,max(coral_dim$max_hull_volume, na.rm = TRUE)+5000)) +
  theme(legend.position="none")

#Proportional difference - coral volume
conv_prop <- ggplot(coral_dim, aes(x=max_hull_volume, y=prop_conv, color=branch_conv))+
  geom_point()+
  geom_smooth(method=lm)+
  theme_classic()+
  xlim(c(0,max(coral_dim$max_hull_volume, na.rm = TRUE)+5000)) +
  labs(y= expression(atop("Percent Volume Difference", "(Manual - Photo)")), x= expression(paste("Convex Hull Volume (cm"^{3},")"))) +
  theme(legend.position = "none")

# Arrange

fig2_nolegend <- plot_grid(plot_est,plot_prop,conv_est,conv_prop, nrow = 2, ncol = 2, align = 'vh', labels = "AUTO")
fig2_legend <- get_legend(plot_est + theme(legend.position = "right"))
fig2_title <- ggdraw() + draw_label("Absolute and Proportional Differences - Manual vs. Photo", fontface = "bold", size = 14)
fig2_w_legend <- plot_grid(fig2_nolegend, fig2_legend, align = 'v', rel_widths = c(10,2))
fig2 <- plot_grid(fig2_title,fig2_w_legend, nrow = 2, rel_heights = c(.1,1))
fig2_fin <- annotate_figure(fig2,
                fig.lab = "Figure 2", fig.lab.face = "bold")  
```

```{r fig2, fig.width = 9, fig.height = 6, message=FALSE, echo = FALSE}
fig2_fin
```

From these visualizations, it appears that there is a trend for the absolute difference in coral volume to be more overestimated by ellipsoid volume, especially in wide-branching colonies. However, the proportion of overestimation of volume as an ellipsoid does not change with coral volume. It's also noteworthy that convex hull measurements in some instances may actually be underestimated by ellipsoid estimation

*Note: For the convex hull branch width graphs, branch width is estimated from convexity. For the coral volume plots, branch width was based on observer determination. This is because we don't have convex hull measurements for all corals, and is temporary. However, only 20% of colonies appear likely to change classification based on the use of convexity as determinant of branch spacing, so the overall trends are unlikely to drastically shift.* 

```{r fig2 cleanup, include = FALSE, message=FALSE}
remove(conv_est, conv_prop, fig2_legend, fig2_nolegend, fig2_title, fig2_w_legend, plot_est, plot_prop, fig2)
```

# How well do manual and digital measurements predict ecological phenomena?

Next, we will look at how much more variation in ecological phenomena may be explained by the improved resolution offered by digital measurements. In this case, we look at the relationship between the composition of resident associated fishes and invertebrates (CAFI) and manually vs. digitally derived measurements of coral volume and available living space.

*Note: This version of the code only includes invertebrates.*


```{r fig3 prep, include=FALSE, include=FALSE}
#Plot invert abundance to  volume
invert_field <- ggplot(cafi_coral, aes(x=volume_field, y=num_cafi))+ 
  geom_point()+
  geom_smooth(method=lm)+
  theme_classic()+
  labs(y="Invertebrate Abundance", x= expression(paste("Manual Volume (cm"^{3},")")))


#Plot invert abundance to software estimated volume
invert_pg <- ggplot(cafi_coral, aes(x=volume_pg, y=num_cafi))+ 
  geom_point()+
  geom_smooth(method=lm)+
  theme_classic()+
  labs(y="Invertebrate Abundance", x= expression(paste("Photogrammetry Volume (cm"^{3},")")))

invert_hull <- ggplot(cafi_coral, aes(x=max_hull_volume, y=num_cafi))+ 
  geom_point()+
  geom_smooth(method=lm)+
  theme_classic()+
  xlim(c(0,max(coral_dim$max_hull_volume, na.rm = TRUE)+5000)) +
  labs(y="Invertebrate Abundance", x= expression(paste("Hull Volume (cm"^{3},")")))

#Plot invert richness to software estimated volume
richness_field <- ggplot(cafi_coral, aes(x=volume_field, y=cafi_richness))+ 
  geom_point()+
  geom_smooth(method=lm)+
  theme_classic()+
  labs(y="Invertebrate Richness", x= expression(paste("Manual Volume (cm"^{3},")")))

#Plot invert richness to software estimated volume
richness_pg <- ggplot(cafi_coral, aes(x=volume_pg, y=cafi_richness))+ 
  geom_point()+
  geom_smooth(method=lm)+
  theme_classic()+
  labs(y="Invertebrate Richness", x= expression(paste("Hull Volume (cm"^{3},")")))

richness_hull <- ggplot(cafi_coral, aes(x=max_hull_volume, y=cafi_richness))+ 
  geom_point()+
  geom_smooth(method=lm)+
  theme_classic()+
  xlim(c(0,max(coral_dim$max_hull_volume, na.rm = TRUE)+5000)) +
  labs(y="Invertebrate Richness", x= expression(paste("Photogrammetry Volume (cm"^{3},")")))


fig3_raw <- plot_grid(invert_field, invert_hull, invert_pg, richness_field, richness_hull, richness_pg, nrow = 2, align = "vh", labels = "AUTO")
fig3_title <- ggdraw() + draw_label("Volume vs. CAFI Comparison", fontface = "bold", size = 14)
fig3 <-  plot_grid(fig3_title,fig3_raw, nrow = 2, rel_heights = c(.1,1))
fig3_fin <- annotate_figure(fig3,
                fig.lab = "Figure 3", fig.lab.face = "bold")  
```

```{r fig3, fig.width = 9, fig.height = 6, message=FALSE, echo = FALSE}
fig3_fin
```

```{r cafi_regression_table, include = FALSE}

lm_invert_field <- lm(num_cafi~volume_field, data=cafi_coral)
lm_invert_pg <- lm(num_cafi~volume_pg, data=cafi_coral)
lm_richness_field <- lm(cafi_richness~volume_field, data=cafi_coral)
lm_richness_pg <- lm(cafi_richness~volume_pg, data=cafi_coral)
lm_invert_hull <- lm(num_cafi~max_hull_volume, data=cafi_coral)
lm_richness_hull <- lm(cafi_richness~max_hull_volume, data=cafi_coral)

pl_ellipse <- c(
  '(Intercept)' = "Intercept",
  volume_field = "Ellipsoid Volume")
pl_volume <- c(
  '(Intercept)' = "Intercept",
  volume_pg = "Photogrammetry Volume")
pl_hull <- c(
  '(Intercept)' = "Intercept",
  max_hull_volume = "Hull Volume")

cafi_volume_reg_tab <- tab_model(lm_invert_field, lm_invert_hull, lm_invert_pg,
          show.intercept = FALSE,
          pred.labels = c(pl_ellipse,pl_volume,pl_hull),
          string.est = "Slope",
          string.ci = "Slope CI (95%)",
          string.p = "p-Value",
          digits=5,
          dv.labels = c("Ellipsoid Volume vs. Abundance","Hull Volume vs. Abundance", "Coral Volume vs. Abundance"))

#HTML table comparing volume methods and richness

cafi_richness_reg_tab <- tab_model(lm_richness_field, lm_richness_hull, lm_richness_pg,
          show.intercept = FALSE,
          pred.labels = c(pl_ellipse,pl_volume,pl_hull),
          string.est = "Slope",
          string.ci = "Slope CI (95%)",
          string.p = "p-Value",
          digits=5,
          dv.labels = c("Ellipsoid Volume vs. Richness","Hull Volume vs. Richness", "Coral Volume vs. Richness"))
```

```{r cafi_volume_tables, include = TRUE, echo = FALSE}
cafi_volume_reg_tab
cafi_richness_reg_tab
```

```{r fig3_cleanup, include = FALSE}

remove(pl_ellipse,fig3_raw, fig3_title, invert_field, richness_field, fig3)
```

Now that we've seen that photogrammetry could potentially explain variation better than manual measurements, let's look at which attributes that can be measured with photogrammetry best predict CAFI abundance and richness

```{r fig4prep, message=FALSE, include=FALSE}
#Volume - plot1 
volume <- invert_pg + labs(x=expression(paste("Volume (cm"^{3},")"))) +
  theme(axis.title.y=element_blank())

#Sphericity - plot2
sphericity <- ggplot(cafi_coral, aes(x=sphericity, y=num_cafi))+ 
  geom_point()+
  geom_smooth(method=lm)+
  theme_classic()+
  theme(axis.title.y=element_blank())+
  labs(x="Sphericity")

lm_sphericity <- lm(num_cafi~sphericity, data = cafi_coral)

#Packing - plot3
packing <- ggplot(cafi_coral, aes(x=packing, y=num_cafi))+ 
  geom_point()+
  geom_smooth(method=lm)+
  theme_classic()+
  theme(axis.title.y=element_blank())+
  labs(x="Packing")

lm_packing <- lm(num_cafi~packing, data = cafi_coral)

#Height - plot4
height <- ggplot(cafi_coral, aes(x=height_pg, y=num_cafi))+ 
  geom_point()+
  geom_smooth(method=lm)+
  theme_classic()+
  theme(axis.title.y=element_blank())+
  labs(x="Height (cm)")

lm_height <- lm(num_cafi~height_pg, data = cafi_coral)

#Length - plot5
length <- ggplot(cafi_coral, aes(x=length_pg, y=num_cafi))+ 
  geom_point()+
  geom_smooth(method=lm)+
  theme_classic()+
  theme(axis.title.y=element_blank())+
  labs(x="Length (cm)")

lm_length <- lm(num_cafi~length_pg, data = cafi_coral)

#Width - plot6
width <- ggplot(cafi_coral, aes(x=width_pg, y=num_cafi))+ 
  geom_point()+
  geom_smooth(method=lm)+
  theme_classic()+
  theme(axis.title.y=element_blank())+
  labs(x="Width (cm)")

lm_width <- lm(num_cafi~width_pg, data = cafi_coral)

#Convexity
convexity <- ggplot(cafi_coral, aes(x=convexity, y=num_cafi))+ 
  geom_point()+
  geom_smooth(method=lm)+
  theme_classic()+
  theme(axis.title.y=element_blank())+
  labs(x="Convexity")

lm_conv <- lm(num_cafi~convexity, data = cafi_coral)

#Branch Width
branch_width <- ggplot(cafi_coral, aes(x=avg_w_cm, y=num_cafi))+ 
  geom_point()+
  geom_smooth(method=lm)+
  theme_classic()+
  theme(axis.title.y=element_blank())+
  labs(x="Branch Width (cm)")

lm_bw <- lm(num_cafi~avg_w_cm, data = cafi_coral)

#Interstitial Space
interstitial <- ggplot(cafi_coral, aes(x=interstitial_space, y=num_cafi))+ 
  geom_point()+
  geom_smooth(method=lm)+
  theme_classic()+
  theme(axis.title.y=element_blank())+
  labs(x=expression(paste("Interstitial Volume (cm"^{3},")")))

lm_interstitial <- lm(num_cafi~interstitial_space, data = cafi_coral)

#Surface Area
surface_area <- ggplot(cafi_coral, aes(x=SA, y=num_cafi))+ 
  geom_point()+
  geom_smooth(method=lm)+
  theme_classic()+
  theme(axis.title.y=element_blank())+
  labs(x=expression(paste("Surface Area (cm"^{2},")")))

lm_invert_sa <- lm(num_cafi~SA, data = cafi_coral)

SAV <- ggplot(cafi_coral, aes(x=SAV, y=num_cafi))+ 
  geom_point()+
  geom_smooth(method=lm)+
  theme_classic()+
  theme(axis.title.y=element_blank())+
  labs(x=expression(paste("Surface Area/Volume")))

lm_invert_sav <- lm(num_cafi~SAV, data = cafi_coral)

convex_SA <- ggplot(cafi_coral, aes(x=max_hull_SA, y=num_cafi))+ 
  geom_point()+
  geom_smooth(method=lm)+
  theme_classic()+
  theme(axis.title.y=element_blank())+
  labs(x=expression(paste("Hull Surface Area (cm"^{2},")")))

lm_convex_sa <- lm(num_cafi~max_hull_SA, data = cafi_coral)

convex_hull <- invert_hull + labs(x=expression(paste("Hull Volume (cm"^{3},")"))) +
  theme(axis.title.y=element_blank())

fig4_title <- ggdraw() + draw_label("Morphological Attributes vs. CAFI Abundance", fontface = "bold", size = 14)
fig4_raw <- plot_grid(volume, surface_area, SAV, 
                  convex_hull, convex_SA, convexity,
                  sphericity, interstitial, branch_width,
                  length, width, height, 
                  ncol = 3, nrow = 4, align = "vh"
                  )

fig4 <- plot_grid(fig4_title,fig4_raw, nrow = 2, rel_heights = c(.1,1))
fig4_fin <- annotate_figure(fig4,
                left = text_grob("CAFI Abundance", color = "black",
                                   rot = 90, face = "bold", size = 12),
                fig.lab = "Figure 4", fig.lab.face = "bold")


```

```{r fig4, include = TRUE, fig.width = 9, fig.height = 10, echo = FALSE}
fig4_fin
```

```{r cafi_morph_regression_table prep, include = FALSE}
pl_sa <- c(
  '(Intercept)' = "Intercept",
  max_hull_volume = "Surface Area")
pl_sav <- c(
  '(Intercept)' = "Intercept",
  max_hull_volume = "Surface Area:Volume")
pl_hull_sa <- c(
  '(Intercept)' = "Intercept",
  max_hull_volume = "Hull Surface Area")
pl_convexity <- c(
  '(Intercept)' = "Intercept",
  max_hull_volume = "Convexity")
pl_sphericity <- c(
  '(Intercept)' = "Intercept",
  max_hull_volume = "Sphericity")
pl_interstitial <- c(
  '(Intercept)' = "Intercept",
  max_hull_volume = "Interstitial Space")
pl_convexity <- c(
  '(Intercept)' = "Intercept",
  max_hull_volume = "Convexity")
pl_bw <- c(
  '(Intercept)' = "Intercept",
  max_hull_volume = "Branch Width")
pl_length <- c(
  '(Intercept)' = "Intercept",
  max_hull_volume = "Length")
pl_width <- c(
  '(Intercept)' = "Intercept",
  max_hull_volume = "Width")
pl_height <- c(
  '(Intercept)' = "Intercept",
  max_hull_volume = "Height")

cafi_morph_tab1 <- tab_model(lm_invert_pg, lm_invert_sa, lm_invert_sav,
          show.intercept = FALSE,
          pred.labels = c(pl_volume,pl_sa,pl_sav),
          string.est = "Slope",
          string.ci = "Slope CI (95%)",
          string.p = "p-Value",
          digits=5,
          dv.labels = c("Photo Volume vs. Abundance","Surface Area vs. Abundance", "Surface Area:Volume vs. Abundance"))

cafi_morph_tab2 <-tab_model(lm_invert_hull, lm_convex_sa, lm_conv,
          show.intercept = FALSE,
          pred.labels = c(pl_hull,pl_hull_sa,pl_convexity),
          string.est = "Slope",
          string.ci = "Slope CI (95%)",
          string.p = "p-Value",
          digits=5,
          dv.labels = c("Hull Volume vs. Abundance","Hull Surface Area vs. Abundance", "Convexity vs. Abundance"))

cafi_morph_tab3<- tab_model(lm_sphericity, lm_interstitial, lm_bw,
          show.intercept = FALSE,
          pred.labels = c(pl_sphericity,pl_interstitial,pl_bw),
          string.est = "Slope",
          string.ci = "Slope CI (95%)",
          string.p = "p-Value",
          digits=5,
          dv.labels = c("Sphericity vs. Abundance","Interstitial Space vs. Abundance", "Branch Width vs. Abundance"))

cafi_morph_tab4 <- tab_model(lm_length, lm_width, lm_height,
          show.intercept = FALSE,
          pred.labels = c(pl_length,pl_width,pl_height),
          string.est = "Slope",
          string.ci = "Slope CI (95%)",
          string.p = "p-Value",
          digits=5,
          dv.labels = c("Length vs. Abundance","Width vs. Abundance", "Height vs. Abundance"))
```

```{r cafi_morph_tab, include = TRUE, echo = FALSE}
cafi_morph_tab1
cafi_morph_tab2
cafi_morph_tab3
cafi_morph_tab4
```

```{r fig4bprep, message=FALSE, include=FALSE}
#Volume - plot1 
volume <- richness_pg + labs(x=expression(paste("Volume (cm"^{3},")"))) +
  theme(axis.title.y=element_blank())

#Sphericity - plot2
sphericity <- ggplot(cafi_coral, aes(x=sphericity, y=cafi_richness))+ 
  geom_point()+
  geom_smooth(method=lm)+
  theme_classic()+
  theme(axis.title.y=element_blank())+
  labs(x="Sphericity")

lm_sphericity <- lm(cafi_richness~sphericity, data = cafi_coral)

#Packing - plot3
packing <- ggplot(cafi_coral, aes(x=packing, y=cafi_richness))+ 
  geom_point()+
  geom_smooth(method=lm)+
  theme_classic()+
  theme(axis.title.y=element_blank())+
  labs(x="Packing")

lm_packing <- lm(cafi_richness~packing, data = cafi_coral)

#Height - plot4
height <- ggplot(cafi_coral, aes(x=height_pg, y=cafi_richness))+ 
  geom_point()+
  geom_smooth(method=lm)+
  theme_classic()+
  theme(axis.title.y=element_blank())+
  labs(x="Height (cm)")

lm_height <- lm(cafi_richness~height_pg, data = cafi_coral)

#Length - plot5
length <- ggplot(cafi_coral, aes(x=length_pg, y=cafi_richness))+ 
  geom_point()+
  geom_smooth(method=lm)+
  theme_classic()+
  theme(axis.title.y=element_blank())+
  labs(x="Length (cm)")

lm_length <- lm(cafi_richness~length_pg, data = cafi_coral)

#Width - plot6
width <- ggplot(cafi_coral, aes(x=width_pg, y=cafi_richness))+ 
  geom_point()+
  geom_smooth(method=lm)+
  theme_classic()+
  theme(axis.title.y=element_blank())+
  labs(x="Width (cm)")

lm_width <- lm(cafi_richness~width_pg, data = cafi_coral)

#Convexity
convexity <- ggplot(cafi_coral, aes(x=convexity, y=cafi_richness))+ 
  geom_point()+
  geom_smooth(method=lm)+
  theme_classic()+
  theme(axis.title.y=element_blank())+
  labs(x="Convexity")

lm_conv <- lm(cafi_richness~convexity, data = cafi_coral)

#Branch Width
branch_width <- ggplot(cafi_coral, aes(x=avg_w_cm, y=cafi_richness))+ 
  geom_point()+
  geom_smooth(method=lm)+
  theme_classic()+
  theme(axis.title.y=element_blank())+
  labs(x="Branch Width (cm)")

lm_bw <- lm(cafi_richness~avg_w_cm, data = cafi_coral)

#Interstitial Space
interstitial <- ggplot(cafi_coral, aes(x=interstitial_space, y=cafi_richness))+ 
  geom_point()+
  geom_smooth(method=lm)+
  theme_classic()+
  theme(axis.title.y=element_blank())+
  labs(x=expression(paste("Interstitial Volume (cm"^{3},")")))

lm_interstitial <- lm(cafi_richness~interstitial_space, data = cafi_coral)

#Surface Area
surface_area <- ggplot(cafi_coral, aes(x=SA, y=cafi_richness))+ 
  geom_point()+
  geom_smooth(method=lm)+
  theme_classic()+
  theme(axis.title.y=element_blank())+
  labs(x=expression(paste("Surface Area (cm"^{2},")")))

lm_invert_sa <- lm(cafi_richness~SA, data = cafi_coral)

SAV <- ggplot(cafi_coral, aes(x=SAV, y=cafi_richness))+ 
  geom_point()+
  geom_smooth(method=lm)+
  theme_classic()+
  theme(axis.title.y=element_blank())+
  labs(x=expression(paste("Surface Area/Volume")))

lm_invert_sav <- lm(cafi_richness~SAV, data = cafi_coral)

convex_SA <- ggplot(cafi_coral, aes(x=max_hull_SA, y=cafi_richness))+ 
  geom_point()+
  geom_smooth(method=lm)+
  theme_classic()+
  theme(axis.title.y=element_blank())+
  labs(x=expression(paste("Hull Surface Area (cm"^{2},")")))

lm_convex_sa <- lm(cafi_richness~max_hull_SA, data = cafi_coral)

convex_hull <- richness_hull + labs(x=expression(paste("Hull Volume (cm"^{3},")"))) +
  theme(axis.title.y=element_blank())

fig4b_title <- ggdraw() + draw_label("Morphological Attributes vs. CAFI Richness", fontface = "bold", size = 14)
fig4b_raw <- plot_grid(volume, surface_area, SAV, 
                  convex_hull, convex_SA, convexity,
                  sphericity, interstitial, branch_width,
                  length, width, height, 
                  ncol = 3, nrow = 4, align = "vh"
                  )

fig4b <- plot_grid(fig4b_title,fig4b_raw, nrow = 2, rel_heights = c(.1,1))
fig4b_fin <- annotate_figure(fig4b,
                left = text_grob("CAFI Richness", color = "black",
                                   rot = 90, face = "bold", size = 12),
                fig.lab = "Figure 4b", fig.lab.face = "bold")


```

```{r fig4b, include = TRUE, fig.width = 9, fig.height = 10, echo = FALSE}
fig4b_fin
```

```{r richness_morph_regression_table prep, include = FALSE}
pl_sa <- c(
  '(Intercept)' = "Intercept",
  max_hull_volume = "Surface Area")
pl_sav <- c(
  '(Intercept)' = "Intercept",
  max_hull_volume = "Surface Area:Volume")
pl_hull_sa <- c(
  '(Intercept)' = "Intercept",
  max_hull_volume = "Hull Surface Area")
pl_convexity <- c(
  '(Intercept)' = "Intercept",
  max_hull_volume = "Convexity")
pl_sphericity <- c(
  '(Intercept)' = "Intercept",
  max_hull_volume = "Sphericity")
pl_interstitial <- c(
  '(Intercept)' = "Intercept",
  max_hull_volume = "Interstitial Space")
pl_convexity <- c(
  '(Intercept)' = "Intercept",
  max_hull_volume = "Convexity")
pl_bw <- c(
  '(Intercept)' = "Intercept",
  max_hull_volume = "Branch Width")
pl_length <- c(
  '(Intercept)' = "Intercept",
  max_hull_volume = "Length")
pl_width <- c(
  '(Intercept)' = "Intercept",
  max_hull_volume = "Width")
pl_height <- c(
  '(Intercept)' = "Intercept",
  max_hull_volume = "Height")

cafi_morph_tab1b <- tab_model(lm_richness_pg, lm_invert_sa, lm_invert_sav,
          show.intercept = FALSE,
          pred.labels = c(pl_volume,pl_sa,pl_sav),
          string.est = "Slope",
          string.ci = "Slope CI (95%)",
          string.p = "p-Value",
          digits=5,
          dv.labels = c("Photo Volume vs. Richness","Surface Area vs. Richness", "Surface Area:Volume vs. Richness"))

cafi_morph_tab2b <-tab_model(lm_richness_hull, lm_convex_sa, lm_conv,
          show.intercept = FALSE,
          pred.labels = c(pl_hull,pl_hull_sa,pl_convexity),
          string.est = "Slope",
          string.ci = "Slope CI (95%)",
          string.p = "p-Value",
          digits=5,
          dv.labels = c("Hull Volume vs. Richness","Hull Surface Area vs. Richness", "Convexity vs. Richness"))

cafi_morph_tab3b<- tab_model(lm_sphericity, lm_interstitial, lm_bw,
          show.intercept = FALSE,
          pred.labels = c(pl_sphericity,pl_interstitial,pl_bw),
          string.est = "Slope",
          string.ci = "Slope CI (95%)",
          string.p = "p-Value",
          digits=5,
          dv.labels = c("Sphericity vs. Richness","Interstitial Space vs. Richness", "Branch Width vs. Richness"))

cafi_morph_tab4b <- tab_model(lm_length, lm_width, lm_height,
          show.intercept = FALSE,
          pred.labels = c(pl_length,pl_width,pl_height),
          string.est = "Slope",
          string.ci = "Slope CI (95%)",
          string.p = "p-Value",
          digits=5,
          dv.labels = c("Length vs. Richness","Width vs. Richness", "Height vs. Richness"))
```

```{r cafi_morph_tab_richness, include = TRUE, echo = FALSE}
cafi_morph_tab1b
cafi_morph_tab2b
cafi_morph_tab3b
cafi_morph_tab4b
```
